<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>detail</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <style>
        body {
            padding: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <table class="table table-bordered table-striped">
        <tr>
            <th>id</th>
            <td th:text="${board.id}"></td>
        </tr>
        <tr>
            <th>title</th>
            <td th:text="${board.getTitle}"></td>
        </tr>
        <tr>
            <th>date</th>
            <td th:text="${#temporals.format(board.getCreateTime, 'yyyy-MM-dd HH:mm')}"></td>
        </tr>
        <tr>
            <th>contents</th>
            <td th:text="${board.getContents}"></td>
        </tr>
    </table>
    <div class="mb-3">
        <div th:if="${files != null}">
            <h3>첨부 파일</h3>
            <ul>
                <li th:each="file : ${files}">
                    <!-- Download link with Bootstrap button style -->
                    <a th:href="@{/download/{uuid}/{filename}(uuid=${file.uuid}, filename=${file.fileName})}"
                       class="btn btn-primary btn-sm">Download</a>
                </li>
            </ul>
        </div>

        <button onclick="listReq()" class="btn btn-secondary">목록</button>
        <button onclick="updateReq()" class="btn btn-primary">수정</button>
        <button onclick="deleteReq()" class="btn btn-danger">삭제</button>
    </div>

    <!-- 댓글 작성 부분 -->
    <div id="comment-write" class="form-group">
        <input type="text" id="writer" placeholder="작성자" class="form-control">
        <input type="text" id="contents" placeholder="내용" class="form-control">
        <button id="comment-write-btn" onclick="commentWrite()" class="btn btn-primary">댓글작성</button>
    </div>

    <!-- 댓글 수정 폼 -->
    <div id="comment-edit" class="form-group" style="display: none;">
        <input type="text" id="editContents" placeholder="내용" class="form-control">
        <button id="comment-edit-btn" onclick="commentEdit(currentCommentId)" class="btn btn-primary">댓글수정</button>
    </div>

    <!-- 댓글 출력 부분 -->
    <div id="comment-list">
        <table class="table table-bordered table-striped">
            <tr>
                <th>댓글번호</th>
                <th>작성자</th>
                <th>내용</th>
                <th>동작</th>
            </tr>
            <tr th:each="comment: ${commentList}">
                <td th:text="${comment.id}"></td>
                <td th:text="${comment.writer}"></td>
                <td th:text="${comment.contents}"></td>
                <td>
                    <button class="btn btn-primary" onclick="showUpdateForm(${comment.id}, '${comment.writer}', '${comment.contents}')">수정</button>
                    <button class="btn btn-danger" onclick="'deleteComment(' + ${comment.id} + ')';">삭제</button>
                </td>
            </tr>
        </table>
    </div>
</div>
<script th:inline="javascript">
    const commentWrite = () => {
        const jsWriter = document.getElementById("writer").value;
        const jsContents = document.getElementById("contents").value;
        console.log("작성자: ", jsWriter);
        console.log("내용: ", jsContents);
        const jsId = [[${board.id}]];
        $.ajax({
            // 요청방식: post, 요청주소: /comment/save, 요청데이터: 작성자, 작성내용, 게시글번호
            type: "post",
            url: "/comment/save",
            data: {
                "writer": jsWriter,
                "contents": jsContents,
                "boardId": jsId
            },
            success: function (res) {
                   console.log("요청성공", res);
                   let output = "";
                   output += "<tr>";
                   output += "<td>" + res.id + "</td>";
                   output += "<td>" + res.writer + "</td>";
                   output += "<td>" + res.contents + "</td>";
                   output += "<td><button class='btn btn-primary' onclick='showUpdateForm(" + res.id + ")'>수정</button>";
                   output += "<button class='btn btn-danger' onclick='deleteComment(" + res.id + ")'>삭제</button></td>";
                   output += "</tr>";
                   document.getElementById('comment-list').querySelector('table').insertAdjacentHTML('beforeend', output);
                   document.getElementById('writer').value = '';
                   document.getElementById('contents').value = '';
            },
            error: function (err) {
                console.log("요청실패", err);
            }
        });
    }

    function deleteComment(commentId) {
        $.ajax({
            url: '/comment/delete/' + commentId,
            type: 'DELETE',
            success: function(result) {
                console.log("댓글 삭제 성공");
                // 성공적으로 삭제한 후, 댓글 목록을 다시 로드
                loadComments();
            },
            error: function(error) {
                console.log(error);
            }
        });
    }

var editingCommentId; // 현재 수정 중인 댓글의 id를 저장하는 변수

function showUpdateForm(id, writer, contents) {
    // 댓글 수정 폼을 가져옵니다.
    var commentForm = document.getElementById('comment-edit');
    // 수정할 댓글의 작성자와 내용을 수정 폼에 설정합니다.
    document.getElementById('editContents').value = contents || '';
    // 수정 중인 댓글의 id를 저장합니다.
    editingCommentId = id;
    // 수정 버튼의 onclick 이벤트 핸들러를 설정합니다.
    document.getElementById('comment-edit-btn').onclick = function() {
        // 댓글 수정 요청을 처리합니다.
        commentEdit(editingCommentId);
    };
    // 댓글 수정 폼을 보이게 합니다.
    commentForm.style.display = 'block';
}

    function loadComments() {
    const boardId = [[${board.id}]];
    $.ajax({
        url: '/comment/getComments/' + boardId,
        type: 'GET',
        success: function(data) {
            var commentsContainer = $('#comment-list').find('table');
             commentsContainer.find('tr:not(:first)').remove(); // 기존 댓글을 삭제
            $.each(data, function(index, commentDTO) {
                var commentElement = "<tr><td>" + commentDTO.id + "</td><td>" + commentDTO.writer + "</td><td>" + commentDTO.contents + "</td>";
                commentElement += "<td><button class='btn btn-primary' onclick='showUpdateForm(" + commentDTO.id + ")'>수정</button>";
                commentElement += "<button class='btn btn-danger' onclick='deleteComment(" + commentDTO.id + ")'>삭제</button></td></tr>";
                commentsContainer.append(commentElement);
            });
        },
        error: function(error) {
            console.log(error);
        }
    });
}

 $(document).ready(function() {
        loadComments();

        $(document).on('click', 'button[id^="edit-complete-"]', function() {
            const commentId = $(this).attr('id').split('-')[2];
            console.log('Button clicked: ', commentId);
            completeEdit(commentId);
        });
    });

const commentEdit = (id) => {
    const jsContents = document.getElementById('editContents').value;
    console.log("내용: ", jsContents);
    const jsId = id;
    $.ajax({
        type: "PUT", // 'POST'를 'PUT'으로 변경
        url: `/comment/update/${jsId}`, // URL을 '/comment/update'에서 '/update/{id}'로 변경
        data: {
            "id": jsId,
            "contents": jsContents
        },
        success: function (res) {
            console.log("요청승인", res);
            // 댓글 리스트를 다시 불러옵니다.
            loadComments();
        },
        error: function (err) {
            console.log("요청실패", err)
        }
    });
}

    const listReq = () => {
        console.log("목록 요청");
        const page = [[${page}]];
        location.href = "/board/paging?page="+page;
    }
    const updateReq = () => {
        console.log("수정 요청");
        const id = [[${board.id}]];
        location.href = "/board/update/" + id;
    }
    const deleteReq = () => {
        console.log("삭제 요청");
        const id = [[${board.id}]];
        location.href = "/board/delete/" + id;
    }
</script>
</body>
</html>
